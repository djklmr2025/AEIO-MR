<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Arkaios UI ‚Äî Claude con Puter.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://img.icons8.com/fluency/48/robot-2.png" />
  <!-- SDK de Puter -->
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root{--bg:#091017;--surface:#0d1a28;--ink:#e6f1ff;--muted:#9fb4d3;--brand:#7c4dff;--accent:#b388ff;--danger:#ff5b8a;--line:#14314f}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;flex-direction:column;height:100%}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    header h1{font-size:20px;margin:0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0e253e;border:1px solid var(--line);color:#bfe2ff}
    .status{font-size:11px;padding:2px 6px;border-radius:12px;margin-left:8px}
    .status.online{background:#004225;color:#00e1a3;border:1px solid #006b3d}
    .status.offline{background:#3d1a1a;color:#ff5b8a;border:1px solid #5c2929}
    .status.connecting{background:#3d3d1a;color:#e1e100;border:1px solid #5c5c29}
    #history{flex:1;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,.03)}
    .msg{padding:12px;border-radius:12px;margin-bottom:12px;opacity:0;animation:fadeIn .3s forwards}
    .msg.user{background:rgba(0,225,163,.14);border:1px solid rgba(0,225,163,.35);margin-left:15%}
    .msg.ai{background:rgba(124,77,255,.12);border:1px solid rgba(124,77,255,.35);margin-right:15%}
    .msg.ai .tools{margin-top:8px;display:flex;gap:8px}
    .msg.root{background:rgba(255,91,138,.12);border:1px solid rgba(255,91,138,.35)}
    .msg.system{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);text-align:center}
    .head{font-size:12px;color:var(--muted);margin-bottom:6px}
    .content{white-space:pre-wrap;line-height:1.6}
    .attachments{margin-top:8px;border-top:1px dashed var(--line);padding-top:8px;display:flex;flex-wrap:wrap;gap:8px}
    .thumb{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:6px;border-radius:8px;background:var(--surface)}
    .thumb img{max-width:160px;max-height:110px;border-radius:6px;display:block}
    .panel{margin-top:12px;border:1px solid var(--line);background:var(--surface);border-radius:12px;padding:12px}
    textarea{width:100%;min-height:90px;resize:none;background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:10px;padding:12px;color:var(--ink)}
    textarea:focus{outline:none;border-color:var(--brand)}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
    .btn{cursor:pointer;border-radius:10px;padding:10px 14px;border:1px solid var(--line);background:transparent;color:var(--ink);font-size:13px;transition:all .2s}
    .btn:hover{border-color:var(--brand);background:rgba(124,77,255,.1)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--brand);color:#ffffff;border:none;font-weight:600}
    .btn.primary:hover{background:#6b3fe0}
    .btn.warning{border-color:#ff9db8;color:#ffd0dd}
    .filebar{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .previews{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .drop{border:2px dashed var(--line);border-radius:10px;padding:12px;color:var(--muted);text-align:center;transition:border-color .2s}
    .drop.dragover{border-color:var(--brand);background:rgba(124,77,255,.05)}
    .right{margin-left:auto}
    .switch{display:inline-flex;align-items:center;gap:8px;background:#15283f;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .hint{font-size:12px;color:var(--muted)}
    .model-selector {background: var(--surface); border: 1px solid var(--line); border-radius: 10px; padding: 8px 12px; color: var(--ink);}
    .command-palette {background: var(--surface); border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin-bottom: 12px;}
    .command-item {padding: 8px; border-radius: 6px; cursor: pointer; margin-bottom: 4px;}
    .command-item:hover {background: rgba(124,77,255,.1);}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ARKAIOS UI</h1>
      <span class="badge">Puter.js + Claude + OpenAI</span>
      <span class="status connecting" id="connectionStatus">Conectando...</span>
      <select class="model-selector" id="modelSelector">
        <option value="claude-3-7-sonnet">Claude 3.7 Sonnet</option>
        <option value="claude-sonnet-4">Claude Sonnet 4</option>
        <option value="claude-opus-4">Claude Opus 4</option>
        <option value="gpt-4o">GPT-4o (OpenAI)</option>
        <option value="gpt-5-nano">GPT-5 Nano</option>
        <option value="o3-mini">O3 Mini</option>
      </select>
    </header>

    <div class="command-palette" id="commandPalette">
      <h3>üöÄ Comandos Puter.js Disponibles:</h3>
      <div class="command-item" onclick="insertCommand('crear archivo mi_script.py')">üìÅ crear archivo [nombre]</div>
      <div class="command-item" onclick="insertCommand('listar directorio')">üìÇ listar directorio</div>
      <div class="command-item" onclick="insertCommand('abrir editor app.js')">üë®‚Äçüíª abrir editor [archivo]</div>
      <div class="command-item" onclick="insertCommand('generar imagen paisaje futurista')">üé® generar imagen [descripci√≥n]</div>
      <div class="command-item" onclick="insertCommand('buscar en google inteligencia artificial')">üîç buscar en google [consulta]</div>
    </div>

    <main id="history"></main>

    <section class="panel">
      <div class="filebar">
        <input type="file" id="fileInput" multiple accept="image/*,application/pdf,.pdf,.txt,.md,.json" />
        <button class="btn" id="clearBtn" title="Quitar adjuntos">Limpiar adjuntos</button>
        <div class="drop" id="drop">Arrastra y suelta archivos aqu√≠‚Ä¶ o pega con Ctrl+V</div>
      </div>
      <div class="previews" id="previews"></div>

      <textarea id="prompt" placeholder="Escribe tu mensaje‚Ä¶ o usa los comandos de arriba ‚Üë" maxlength="4000"></textarea>
      <div class="row">
        <div>
          <button class="btn" id="cleanChat">Limpiar chat</button>
          <button class="btn warning" id="pingBtn">Probar conexi√≥n</button>
          <button class="btn" id="helpBtn">Ayuda</button>
        </div>
        <button class="btn primary" id="sendBtn">Enviar</button>
      </div>
    </section>
  </div>

  <script>
    // Variables globales
    const historyDiv = document.getElementById('history');
    const input = document.getElementById('prompt');
    const fileInput = document.getElementById('fileInput');
    const previews = document.getElementById('previews');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const pingBtn = document.getElementById('pingBtn');
    const cleanChatBtn = document.getElementById('cleanChat');
    const helpBtn = document.getElementById('helpBtn');
    const statusEl = document.getElementById('connectionStatus');
    const modelSelector = document.getElementById('modelSelector');
    const commandPalette = document.getElementById('commandPalette');
    
    let pendingFiles = [];
    let isConnected = false;
    let conversationHistory = [];

    // Funciones de estado de conexi√≥n
    function updateConnectionStatus(ok) { 
      isConnected = ok; 
      statusEl.textContent = ok ? 'Conectado' : 'Error'; 
      statusEl.className = 'status ' + (ok ? 'online' : 'offline'); 
    }
    
    function setConnecting() { 
      statusEl.textContent = 'Conectando...'; 
      statusEl.className = 'status connecting'; 
    }

    // Insertar comando desde la paleta
    function insertCommand(command) {
      input.value = command;
      input.focus();
    }

    // A√±adir mensaje al historial
    function addMessage({text, who = 'ai', attachments = [], isSystem = false}) {
      const wrap = document.createElement('div');
      let cls = `msg ${who}`; 
      if (isSystem) cls += ' system';
      wrap.className = cls;

      const head = document.createElement('div');
      head.className = 'head';
      head.textContent = isSystem ? 'Sistema' : (who === 'user' ? 'T√∫' : 'Arkaios');

      const body = document.createElement('div');
      body.className = 'content';
      body.textContent = text;

      wrap.appendChild(head);
      wrap.appendChild(body);

      // Bot√≥n para guardar respuesta como archivo .txt
      if (who === 'ai' && !isSystem) {
        const tools = document.createElement('div');
        tools.className = 'tools';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn';
        saveBtn.textContent = 'Guardar respuesta (.txt)';
        saveBtn.onclick = () => {
          const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `arkaios-respuesta-${Date.now()}.txt`;
          a.click();
          URL.revokeObjectURL(a.href);
        };
        tools.appendChild(saveBtn);
        wrap.appendChild(tools);
      }

      // Mostrar archivos adjuntos
      if (attachments?.length) {
        const att = document.createElement('div'); 
        att.className = 'attachments';
        attachments.forEach(a => {
          const box = document.createElement('div'); 
          box.className = 'thumb';
          if (a.type?.startsWith('image/')) {
            const img = new Image(); 
            img.alt = a.name; 
            img.src = a.preview || a.url;
            box.appendChild(img);
          } else {
            const s = document.createElement('span'); 
            s.textContent = 'üìÑ ' + (a.name || a.url); 
            box.appendChild(s);
          }
          att.appendChild(box);
        });
        wrap.appendChild(att);
      }

      historyDiv.appendChild(wrap);
      historyDiv.scrollTop = historyDiv.scrollHeight;
      return wrap;
    }

    // Mostrar previsualizaciones de archivos
    function renderPreviews() {
      previews.innerHTML = '';
      pendingFiles.forEach((f, idx) => {
        const box = document.createElement('div'); 
        box.className = 'thumb'; 
        box.style.position = 'relative';
        
        const x = document.createElement('button'); 
        x.textContent = '√ó';
        x.style.cssText = 'position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:var(--danger);color:#fff;border:none;cursor:pointer;font-size:12px;line-height:1';
        x.onclick = () => { pendingFiles.splice(idx, 1); renderPreviews(); };

        if (f.type.startsWith('image/')) {
          const img = new Image(); 
          img.alt = f.name; 
          img.style.maxWidth = '100px'; 
          img.style.maxHeight = '100px';
          box.appendChild(img);
          const rd = new FileReader(); 
          rd.onload = e => img.src = e.target.result; 
          rd.readAsDataURL(f);
        } else {
          const s = document.createElement('span'); 
          s.textContent = 'üìÑ ' + f.name; 
          s.style.maxWidth = '120px'; 
          s.style.overflow = 'hidden'; 
          s.style.textOverflow = 'ellipsis'; 
          s.style.whiteSpace = 'nowrap'; 
          box.appendChild(s);
        }
        box.appendChild(x); 
        previews.appendChild(box);
      });
    }

    // Manejo de archivos desde input
    fileInput.addEventListener('change', e => {
      const add = Array.from(e.target.files).filter(f => f.size <= 10 * 1024 * 1024);
      if (add.length !== e.target.files.length) {
        addMessage({text: 'Algunos archivos >10MB se omitieron', who: 'ai', isSystem: true});
      }
      pendingFiles = [...pendingFiles, ...add]; 
      renderPreviews(); 
      e.target.value = '';
    });
    
    clearBtn.addEventListener('click', () => { 
      pendingFiles = []; 
      renderPreviews(); 
      fileInput.value = ''; 
    });

    // Drag & Drop
    const drop = document.getElementById('drop');
    ['dragenter', 'dragover'].forEach(ev => { 
      drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add('dragover'); }); 
      document.addEventListener(ev, e => e.preventDefault()); 
    });
    
    ['dragleave', 'drop'].forEach(ev => { 
      drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove('dragover'); }); 
    });
    
    drop.addEventListener('drop', e => { 
      const add = Array.from(e.dataTransfer.files).filter(f => f.size <= 10 * 1024 * 1024);
      if (add.length !== e.dataTransfer.files.length) {
        addMessage({text: 'Algunos archivos >10MB se omitieron', who: 'ai', isSystem: true});
      }
      pendingFiles = [...pendingFiles, ...add]; 
      renderPreviews();
    });

    // Pegar im√°genes con Ctrl+V
    document.addEventListener('paste', async (e) => {
      const items = e.clipboardData?.items || [];
      let found = false;
      for (const it of items) {
        if (it.type && it.type.startsWith('image/')) {
          const blob = it.getAsFile();
          if (blob) {
            const file = new File([blob], `captura-${Date.now()}.png`, {type: blob.type});
            pendingFiles.push(file);
            found = true;
          }
        }
      }
      if (found) { 
        renderPreviews(); 
        addMessage({text: 'üì∏ Captura a√±adida desde portapapeles', who: 'ai', isSystem: true}); 
      }
    });

    // Funci√≥n principal para enviar mensajes
    async function send() {
      const text = input.value.trim();
      if (!text && pendingFiles.length === 0) return;
      if (sendBtn.disabled) return;

      // Mostrar mensaje localmente
      const localPreview = [];
      for (const f of pendingFiles) {
        if (f.type.startsWith('image/')) {
          const p = await new Promise(res => {
            const rd = new FileReader();
            rd.onload = e => res(e.target.result);
            rd.readAsDataURL(f);
          });
          localPreview.push({name: f.name, preview: p, type: f.type});
        } else { 
          localPreview.push({name: f.name, type: f.type}); 
        }
      }
      
      if (text || localPreview.length) {
        addMessage({text: text || '(adjuntos)', who: 'user', attachments: localPreview});
      }
      
      input.value = '';
      sendBtn.disabled = true;
      sendBtn.textContent = 'Enviando‚Ä¶';

      try {
        // Detectar si es un comando especial para el servidor
        const isRootQuery = text.toLowerCase().includes('buscar en google') || 
                           text.toLowerCase().includes('busca en google') ||
                           text.toLowerCase().includes('googlear');
        
        const isPuterCommand = text.toLowerCase().includes('crear archivo') ||
                              text.toLowerCase().includes('listar directorio') ||
                              text.toLowerCase().includes('abrir editor') ||
                              text.toLowerCase().includes('generar imagen') ||
                              text.toLowerCase().includes('analizar imagen');
        
        if (isRootQuery || isPuterCommand) {
          // Enviar al servidor para procesamiento especial
          const response = await fetch('/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: text,
              files: localPreview,
              root: isRootQuery,
              conversationId: 'arkaios-puter-mode'
            })
          });
          
          const data = await response.json();
          addMessage({
            text: data.respuesta,
            who: 'ai'
          });
        } else {
          // Mensaje normal: usar Puter.js directamente
          const selectedModel = modelSelector.value;
          
          // Construir mensaje con archivos (si hay)
          let fullMessage = text;
          if (pendingFiles.length > 0) {
            fullMessage += "\n\nArchivos adjuntos:";
            pendingFiles.forEach(file => {
              fullMessage += `\n- ${file.name} (${file.type})`;
            });
          }
          
          // Enviar a IA usando Puter.js
          let aiResponse;
          
          if (selectedModel.includes('gpt-') || selectedModel.includes('o')) {
            // Usar OpenAI via Puter.js
            const response = await puter.ai.chat(fullMessage, {
              model: selectedModel,
              stream: false
            });
            aiResponse = response.message.content[0].text;
          } else {
            // Usar Claude via Puter.js
            const response = await puter.ai.chat(fullMessage, {
              model: selectedModel,
              stream: false
            });
            aiResponse = response.message.content[0].text;
          }
          
          // Mostrar respuesta
          updateConnectionStatus(true);
          addMessage({
            text: aiResponse,
            who: 'ai'
          });
        }

      } catch (error) {
        console.error('Error:', error);
        updateConnectionStatus(false);
        addMessage({
          text: '‚ùå Error: ' + (error.message || 'Error desconocido'),
          who: 'ai', 
          isSystem: true
        });
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Enviar';
        pendingFiles = [];
        renderPreviews();
        fileInput.value = '';
      }
    }

    // Limpiar chat
    cleanChatBtn.addEventListener('click', () => {
      if (!confirm('¬øBorrar historial de conversaci√≥n?')) return;
      historyDiv.innerHTML = '';
      conversationHistory = [];
      addMessage({
        text: 'Conversaci√≥n reiniciada. ¬°Hola de nuevo!',
        who: 'ai', 
        isSystem: true
      });
    });

    // Probar conexi√≥n con Puter
    pingBtn.addEventListener('click', async () => {
      pingBtn.disabled = true;
      pingBtn.textContent = 'Probando‚Ä¶';
      setConnecting();
      
      try {
        // Verificar que Puter.js est√° cargado y funciona
        if (typeof puter !== 'undefined' && typeof puter.ai !== 'undefined') {
          // Probar m√∫ltiples modelos
          const modelsToTest = ['claude-3-7-sonnet', 'gpt-4o', 'gpt-5-nano'];
          let testResults = [];
          
          for (const model of modelsToTest) {
            try {
              const testResponse = await puter.ai.chat('Hola', {
                model: model,
                stream: false
              });
              testResults.push(`‚úÖ ${model}: OK`);
            } catch (e) {
              testResults.push(`‚ùå ${model}: Error`);
            }
          }
          
          updateConnectionStatus(true);
          addMessage({
            text: '‚úÖ Puter.js cargado correctamente\n' + testResults.join('\n'),
            who: 'ai', 
            isSystem: true
          });
        } else {
          throw new Error('Puter.js no est√° disponible');
        }
      } catch (error) {
        updateConnectionStatus(false);
        addMessage({
          text: '‚ùå Error de conexi√≥n: ' + error.message,
          who: 'ai', 
          isSystem: true
        });
      } finally {
        pingBtn.disabled = false;
        pingBtn.textContent = 'Probar conexi√≥n';
      }
    });

    // Mostrar ayuda
    helpBtn.addEventListener('click', () => {
      addMessage({
        text: `üöÄ **COMANDOS DISPONIBLES:**\n
üìÅ Sistema de Archivos:
‚Ä¢ crear archivo [nombre] - Crear nuevo archivo
‚Ä¢ listar directorio - Ver archivos actuales
‚Ä¢ abrir editor [archivo] - Abrir en editor de c√≥digo

üé® Multimedia:
‚Ä¢ generar imagen [descripci√≥n] - Crear con DALL-E 3
‚Ä¢ analizar imagen [url] - Analizar imagen con IA

üîç B√∫squedas:
‚Ä¢ buscar en google [consulta] - B√∫squeda web

ü§ñ Modelos Disponibles:
‚Ä¢ Claude 3.7 Sonnet/Opus
‚Ä¢ GPT-4o, GPT-5 Nano
‚Ä¢ O1, O3 Mini
‚Ä¢ DALL-E 3 para im√°genes`,
        who: 'ai',
        isSystem: true
      });
    });

    // Event listeners
    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Inicializar
    async function init() {
      try {
        // Verificar que Puter.js est√° cargado
        if (typeof puter !== 'undefined') {
          updateConnectionStatus(true);
          addMessage({
            text: '¬°Hola! Soy Arkaios con acceso completo a Puter.js. üöÄ\n\nPuedo usar:\n‚Ä¢ Claude 3.7 Sonnet/Opus\n‚Ä¢ GPT-4o, GPT-5 Nano\n‚Ä¢ DALL-E 3 para im√°genes\n‚Ä¢ Sistema de archivos completo\n\nUsa los comandos de arriba o escribe "ayuda" para m√°s informaci√≥n.',
            who: 'ai'
          });
          
          // Cargar modelos disponibles
          try {
            const response = await fetch('/puter/models');
            const data = await response.json();
            console.log('Modelos disponibles:', data);
          } catch (e) {
            console.log('No se pudieron cargar modelos del servidor');
          }
        } else {
          throw new Error('Puter.js no se carg√≥ correctamente');
        }
      } catch (error) {
        updateConnectionStatus(false);
        addMessage({
          text: '‚ùå Error: ' + error.message,
          who: 'ai', 
          isSystem: true
        });
      }
    }
    
    window.addEventListener('load', init);
  </script>
</body>
</html>