<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Arkaios UI — Gemini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://img.icons8.com/fluency/48/robot-2.png" />
  <style>
    :root{--bg:#091017;--surface:#0d1a28;--ink:#e6f1ff;--muted:#9fb4d3;--brand:#00e1a3;--accent:#4ea2ff;--danger:#ff5b8a;--line:#14314f}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:flex;flex-direction:column;height:100%}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    header h1{font-size:20px;margin:0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0e253e;border:1px solid var(--line);color:#bfe2ff}
    .status{font-size:11px;padding:2px 6px;border-radius:12px;margin-left:8px}
    .status.online{background:#004225;color:#00e1a3;border:1px solid #006b3d}
    .status.offline{background:#3d1a1a;color:#ff5b8a;border:1px solid #5c2929}
    .status.connecting{background:#3d3d1a;color:#e1e100;border:1px solid #5c5c29}
    #history{flex:1;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,.03)}
    .msg{padding:12px;border-radius:12px;margin-bottom:12px;opacity:0;animation:fadeIn .3s forwards}
    .msg.user{background:rgba(0,225,163,.14);border:1px solid rgba(0,225,163,.35);margin-left:15%}
    .msg.ai{background:rgba(78,162,255,.12);border:1px solid rgba(78,162,255,.35);margin-right:15%}
    .msg.root{background:rgba(255,91,138,.12);border:1px solid rgba(255,91,138,.35)}
    .msg.system{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);text-align:center}
    .head{font-size:12px;color:var(--muted);margin-bottom:6px}
    .content{white-space:pre-wrap;line-height:1.6}
    .attachments{margin-top:8px;border-top:1px dashed var(--line);padding-top:8px;display:flex;flex-wrap:wrap;gap:8px}
    .thumb{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:6px;border-radius:8px;background:var(--surface)}
    .thumb img{max-width:160px;max-height:110px;border-radius:6px;display:block}
    .panel{margin-top:12px;border:1px solid var(--line);background:var(--surface);border-radius:12px;padding:12px}
    textarea{width:100%;min-height:90px;resize:none;background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:10px;padding:12px;color:var(--ink)}
    textarea:focus{outline:none;border-color:var(--brand)}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
    .btn{cursor:pointer;border-radius:10px;padding:10px 14px;border:1px solid var(--line);background:transparent;color:var(--ink);font-size:13px;transition:all .2s}
    .btn:hover{border-color:var(--brand);background:rgba(0,225,163,.1)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--brand);color:#001b12;border:none;font-weight:600}
    .btn.primary:hover{background:#00c491}
    .btn.warning{border-color:#ff9db8;color:#ffd0dd}
    .filebar{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .previews{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .drop{border:2px dashed var(--line);border-radius:10px;padding:12px;color:var(--muted);text-align:center;transition:border-color .2s}
    .drop.dragover{border-color:var(--brand);background:rgba(0,225,163,.05)}
    .right{margin-left:auto}
    .switch{display:inline-flex;align-items:center;gap:8px;background:#15283f;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .switch input{accent-color:var(--brand)}
    .hint{font-size:12px;color:var(--muted)}
    .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .tag{display:inline-block;font-size:11px;padding:3px 6px;border:1px solid var(--line);border-radius:999px;margin-right:6px;background:#0e253e;color:#bfe2ff}
    /* Spinner overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
    .spinner{width:68px;height:68px;border-radius:50%;border:6px solid rgba(255,255,255,.15);border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ARKAIOS UI</h1>
      <span class="badge">Proveedor: Gemini</span>
      <span class="status connecting" id="connectionStatus">Conectando...</span>

      <span class="right switch" title="Generación de imágenes (HuggingFace)">
        <input type="checkbox" id="imgToggle" />
        <label for="imgToggle">Imagen (HF)</label>
      </span>
      <span class="switch" title="Generación 3D (Hunyuan)">
        <input type="checkbox" id="threedToggle" />
        <label for="threedToggle">3D (Hunyuan)</label>
      </span>

      <span class="switch" title="Modo ROOT forzado desde el servidor">
        <input type="checkbox" id="rootToggle" checked disabled />
        <label for="rootToggle">Modo ROOT</label>
      </span>
    </header>

    <main id="history"></main>

    <section class="panel">
      <div class="filebar">
        <input type="file" id="fileInput" multiple accept="image/*,application/pdf,.pdf,.txt,.md,.json" />
        <button class="btn" id="clearBtn" title="Quitar adjuntos">Limpiar adjuntos</button>
        <div class="drop" id="drop">Arrastra y suelta archivos aquí… o pega con Ctrl+V</div>
      </div>
      <div class="previews" id="previews"></div>

      <textarea id="prompt" placeholder="Escribe tu mensaje… (prueba: 'genera una imagen de un gato steampunk')" maxlength="4000"></textarea>
      <div class="row">
        <div>
          <button class="btn" id="cleanChat">Limpiar chat</button>
          <button class="btn warning" id="pingBtn">Ping</button>
          <span class="hint" id="cidLabel"></span>
        </div>
        <button class="btn primary" id="sendBtn">Enviar</button>
      </div>
    </section>
  </div>

  <!-- overlay spinner -->
  <div class="overlay" id="overlay"><div class="spinner" aria-label="procesando"></div></div>

  <script>
    const API_BASE = window.location.origin;
    const CONVO_KEY = 'arkaios_gemini_convo';
    const AUTH_KEY  = 'ARKAIOS_AUTH';

    // token opcional desde ?auth=
    const params = new URLSearchParams(location.search);
    const urlAuth = params.get('auth');
    if (urlAuth) localStorage.setItem(AUTH_KEY, urlAuth);
    const AUTH = localStorage.getItem(AUTH_KEY) || '';

    let conversationId = localStorage.getItem(CONVO_KEY);
    if (!conversationId) {
      conversationId = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
      localStorage.setItem(CONVO_KEY, conversationId);
    }

    const historyDiv = document.getElementById('history');
    const input = document.getElementById('prompt');
    const fileInput = document.getElementById('fileInput');
    const previews = document.getElementById('previews');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const pingBtn = document.getElementById('pingBtn');
    const rootToggle = document.getElementById('rootToggle');
    const imgToggle = document.getElementById('imgToggle');
    const threedToggle = document.getElementById('threedToggle');
    const cidLabel = document.getElementById('cidLabel');
    const statusEl = document.getElementById('connectionStatus');
    const overlay = document.getElementById('overlay');

    // estados por defecto (puedes cambiarlos)
    imgToggle.checked = true;      // Imagen HF ON por defecto
    threedToggle.checked = false;  // 3D OFF por defecto

    cidLabel.textContent = `CID: ${conversationId.slice(0,8)}…`;

    let pendingFiles = [];
    let isConnected = false;

    function updateConnectionStatus(ok){ isConnected=ok; statusEl.textContent=ok?'Conectado':'Desconectado'; statusEl.className='status '+(ok?'online':'offline'); }
    function setConnecting(){ statusEl.textContent='Conectando...'; statusEl.className='status connecting'; }

    function addMessage({text, who='ai', attachments=[], isSystem=false, meta=null}){
      const wrap = document.createElement('div');
      let cls = `msg ${who}`; if(isSystem) cls+=' system'; if(who==='ai') cls+=' root';
      wrap.className = cls;

      const head = document.createElement('div');
      head.className='head';
      head.textContent = isSystem ? 'Sistema' : (who==='user' ? 'Tú' : 'Arkaios (ROOT/Gemini)');

      const body = document.createElement('div');
      body.className='content';
      body.textContent = text;

      wrap.appendChild(head);
      wrap.appendChild(body);

      // meta / log de modelo
      if (meta) {
        const metaLine = [];
        if (meta.model_used) metaLine.push(`LLM: ${meta.model_used}`);
        if (meta.image_model) metaLine.push(`Img: ${meta.image_model}`);
        if (meta.three_d_model) metaLine.push(`3D: ${meta.three_d_model}`);
        if (meta.flags) {
          const f = [];
          if (meta.flags.imageHF) f.push('Imagen(HF)');
          if (meta.flags.threeD) f.push('3D(Hunyuan)');
          if (f.length) metaLine.push(`Flags: ${f.join(', ')}`);
        }
        if (metaLine.length) {
          const metaDiv = document.createElement('div');
          metaDiv.className = 'meta';
          metaLine.forEach(t => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = t;
            metaDiv.appendChild(tag);
          });
          wrap.appendChild(metaDiv);
        }
      }

      // botón para guardar respuesta como archivo .txt
      if (who === 'ai' && !isSystem) {
        const tools = document.createElement('div');
        tools.className = 'tools';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn';
        saveBtn.textContent = 'Guardar respuesta (.txt)';
        saveBtn.onclick = () => {
          const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `arkaios-respuesta-${Date.now()}.txt`;
          a.click();
          URL.revokeObjectURL(a.href);
        };
        tools.appendChild(saveBtn);
        wrap.appendChild(tools);
      }

      // adjuntos (imágenes / links)
      if (attachments?.length){
        const att = document.createElement('div'); att.className='attachments';
        attachments.forEach(a=>{
          const box=document.createElement('div'); box.className='thumb';
          if(a.type?.startsWith?.('image/')){
            const img=new Image(); img.alt=a.name||'imagen'; img.src=a.preview||a.url;
            box.appendChild(img);
          } else if (a.url && a.name) {
            const link = document.createElement('a'); link.href=a.url; link.textContent=a.name; link.target='_blank';
            const s=document.createElement('span'); s.appendChild(link); box.appendChild(s);
          } else {
            const s=document.createElement('span'); s.textContent='📄 '+(a.name||a.url||'archivo'); box.appendChild(s);
          }
          att.appendChild(box);
        });
        wrap.appendChild(att);
      }

      historyDiv.appendChild(wrap);
      historyDiv.scrollTop = historyDiv.scrollHeight;
      return wrap;
    }

    function renderPreviews(){
      previews.innerHTML='';
      pendingFiles.forEach((f,idx)=>{
        const box=document.createElement('div'); box.className='thumb'; box.style.position='relative';
        const x=document.createElement('button'); x.textContent='×';
        x.style.cssText='position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:var(--danger);color:#fff;border:none;cursor:pointer;font-size:12px;line-height:1';
        x.onclick=()=>{pendingFiles.splice(idx,1); renderPreviews();};

        if(f.type.startsWith('image/')){
          const img=new Image(); img.alt=f.name; img.style.maxWidth='100px'; img.style.maxHeight='100px';
          box.appendChild(img);
          const rd=new FileReader(); rd.onload=e=>img.src=e.target.result; rd.readAsDataURL(f);
        } else {
          const s=document.createElement('span'); s.textContent='📄 '+f.name; s.style.maxWidth='120px'; s.style.overflow='hidden'; s.style.textOverflow='ellipsis'; s.style.whiteSpace='nowrap'; box.appendChild(s);
        }
        box.appendChild(x); previews.appendChild(box);
      });
    }

    // ====== ARCHIVOS DESDE INPUT ======
    fileInput.addEventListener('change', e=>{
      const add = Array.from(e.target.files).filter(f=>f.size<=10*1024*1024);
      if(add.length!==e.target.files.length) addMessage({text:'Algunos archivos >10MB se omitieron', who:'ai', isSystem:true});
      pendingFiles=[...pendingFiles,...add]; renderPreviews(); e.target.value='';
    });
    clearBtn.addEventListener('click',()=>{ pendingFiles=[]; renderPreviews(); fileInput.value=''; });

    // ====== DRAG & DROP ======
    const drop=document.getElementById('drop');
    ['dragenter','dragover'].forEach(ev=>{ drop.addEventListener(ev,e=>{e.preventDefault(); drop.classList.add('dragover');}); document.addEventListener(ev,e=>e.preventDefault()); });
    ['dragleave','drop'].forEach(ev=>{ drop.addEventListener(ev,e=>{e.preventDefault(); drop.classList.remove('dragover');}); });
    drop.addEventListener('drop',e=>{ 
      const add = Array.from(e.dataTransfer.files).filter(f=>f.size<=10*1024*1024);
      if(add.length!==e.dataTransfer.files.length) addMessage({text:'Algunos archivos >10MB se omitieron', who:'ai', isSystem:true});
      pendingFiles=[...pendingFiles,...add]; renderPreviews();
    });

    // ====== PEGAR (Ctrl+V) IMÁGENES ======
    document.addEventListener('paste', async (e)=>{
      const items = e.clipboardData?.items || [];
      let found = false;
      for (const it of items) {
        if (it.type && it.type.startsWith('image/')) {
          const blob = it.getAsFile();
          if (blob) {
            const file = new File([blob], `captura-${Date.now()}.png`, {type: blob.type});
            pendingFiles.push(file);
            found = true;
          }
        }
      }
      if (found) { renderPreviews(); addMessage({text:'📸 Captura añadida desde portapapeles', who:'ai', isSystem:true}); }
    });

    async function uploadFiles(){
      if(!pendingFiles.length) return [];
      const form=new FormData(); pendingFiles.forEach(f=>form.append('files',f));
      const headers = AUTH ? {'Authorization':'Bearer '+AUTH} : undefined;
      const r = await fetch(`${API_BASE}/upload`, {method:'POST', headers, body:form});
      if(!r.ok){ const t = await r.text(); throw new Error(`Error al subir: ${r.status} ${r.statusText} - ${t}`); }
      const d = await r.json(); return d.files||[];
    }

    function showOverlay(on){ overlay.style.display = on ? 'flex' : 'none'; }

    async function send(){
      const text = input.value.trim();
      if(!text && pendingFiles.length===0) return;
      if(sendBtn.disabled) return;

      // eco local
      const localPreview=[];
      for(const f of pendingFiles){
        if(f.type.startsWith('image/')){
          const p = await new Promise(res=>{const rd=new FileReader(); rd.onload=e=>res(e.target.result); rd.readAsDataURL(f);});
          localPreview.push({name:f.name, preview:p, type:f.type});
        } else { localPreview.push({name:f.name, type:f.type}); }
      }
      if(text || localPreview.length) addMessage({text:text||'(adjuntos)', who:'user', attachments:localPreview});
      input.value='';

      const flags = { imageHF: imgToggle.checked, threeD: threedToggle.checked };
      sendBtn.disabled=true; sendBtn.textContent='Enviando…'; showOverlay(true);

      try{
        const uploaded = await uploadFiles();
        const payload = { message: text, files: uploaded, root: true, conversationId, flags, ui_flags: flags };
        const headers = {'Content-Type':'application/json'}; if (AUTH) headers['Authorization']='Bearer '+AUTH;

        const r = await fetch(`${API_BASE}/chat`, {method:'POST', headers, body:JSON.stringify(payload)});
        if(!r.ok){ let m; try{m=(await r.json()).respuesta;}catch{m=`Error ${r.status}`;} throw new Error(m); }
        const data = await r.json();
        updateConnectionStatus(true);

        // adjuntos devueltos por server (imágenes generadas o artefactos 3D)
        const extraAttachments = [];
        (data.generated_images||[]).forEach((url,i)=>extraAttachments.push({url, name:`imagen_${i+1}.png`, type:'image/png'}));
        (data.generated_3d||[]).forEach((obj,i)=>extraAttachments.push({url:obj.url, name:obj.name||`asset_${i+1}`, type:'application/octet-stream'}));

        const meta = {
          model_used: data.model_used,
          image_model: data.image_model,
          three_d_model: data.three_d_model,
          flags
        };

        addMessage({
          text: data.respuesta || '(sin respuesta)',
          who:'ai',
          attachments:[...uploaded, ...extraAttachments],
          meta
        });
      }catch(e){
        updateConnectionStatus(false);
        addMessage({text:'❌ '+e.message, who:'ai', isSystem:true});
      }finally{
        sendBtn.disabled=false; sendBtn.textContent='Enviar';
        pendingFiles=[]; renderPreviews(); fileInput.value='';
        showOverlay(false);
      }
    }

    document.getElementById('sendBtn').addEventListener('click', send);
    input.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });
    document.getElementById('cleanChat').addEventListener('click', async ()=>{
      if(!confirm('¿Borrar historial y memoria de esta conversación?')) return;
      try{
        const headers = {'Content-Type':'application/json'}; if (AUTH) headers['Authorization']='Bearer '+AUTH;
        await fetch(`${API_BASE}/clear`, {method:'POST', headers, body:JSON.stringify({conversationId})});
      }catch{}
      historyDiv.innerHTML=''; addMessage({text:'Memoria e historial borrados.', who:'ai', isSystem:true});
    });

    document.getElementById('pingBtn').addEventListener('click', async ()=>{
      pingBtn.disabled=true; pingBtn.textContent='Probando…'; setConnecting();
      try{
        const headers = AUTH ? {'Authorization':'Bearer '+AUTH} : undefined;
        const r = await fetch(`${API_BASE}/health`, {method:'GET', cache:'no-cache', headers});
        if(r.ok){ const d=await r.json(); updateConnectionStatus(true);
          addMessage({text:`✅ Servidor OK\n- ROOT forzado: ${d.root_force_on}\n- CSE: ${d.google_cse_configured}\n- Ext: ${d.root_allow_external}\n- Auth: ${d.auth_required}`, who:'ai', isSystem:true});
        } else { updateConnectionStatus(false); addMessage({text:'❌ '+r.status, who:'ai', isSystem:true}); }
      }catch(e){ updateConnectionStatus(false); addMessage({text:'❌ '+e.message, who:'ai', isSystem:true}); }
      finally{ pingBtn.disabled=false; pingBtn.textContent='Ping'; }
    });

    async function init(){
      try{ const r=await fetch(`${API_BASE}/health`,{method:'GET',cache:'no-cache'}); updateConnectionStatus(r.ok); }catch{updateConnectionStatus(false);}
      addMessage({text:'¡Hola! Soy Arkaios (ROOT/Gemini). Pruébame con:\n- "genera una imagen de un gato steampunk"\n- "convierte esto en 3D: ... (si tienes Hunyuan)".', who:'ai'});
    }
    window.addEventListener('load', init);
  </script>
</body>
</html>
